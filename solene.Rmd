---
title: "R Notebook"
output: html_notebook
---
```{r, include=FALSE}
# echo false pour toutes les cellules
knitr::opts_chunk$set(echo = FALSE) 

# Deleting previous environment
rm(list = ls())

# Importing needed libraries
library(dplyr)
library(ggplot2)
library(GGally)
```

## **Step 1: Data Cleaning and Preparation**

First, we import the data. Then we look at the beginning of the table to familiarize ourselves with it. And we create a summary to get an overview of the range of numerical values.

```{r}
data = read.csv('diabetes.csv')
head(data)
summary(data) 
```

We observe that certain values are 0. However, this does not always make sense in a medical context. We deduce that these values are missing. We will replace them with ‘NA’.

```{r}
cols_with_zeros = c("Glucose", "BloodPressure", "SkinThickness", "Insulin", "BMI")

# Remplacer les zéros par NA dans ces colonnes
data = data %>%
  mutate(across(all_of(cols_with_zeros), ~na_if(., 0)))

head(data)
```

The ‘NA’ value count:

```{r}
colSums(is.na(data))
```

In order to analyze our dataset, we need to fill in the ‘NA’ values. We choose to replace them with the median of their respective column.

```{r}
for (col in cols_with_zeros) {
  median_value = median(data[[col]], na.rm = TRUE)
  data[[col]][is.na(data[[col]])] = median_value
}

head(data)
```

All ‘NA’ values have been replaced & no more 0 remains:

```{r}
colSums(is.na(data))
cat("\n") # Ajout d'une ligne vide
sapply(data[cols_with_zeros], function(x) sum(x == 0))
```
Step 2: Feature Transformation and Engineering 

```{r}
#standard WHO thresholds: underweight, normal weight, overweight, obese
#got the values from the WHO
data <- data %>% mutate(BMICategory = case_when(BMI<18.5 ~ 'Underweight', BMI>=18.5 & BMI<25 ~ 'Normal weight', BMI>=25 & BMI<30 ~ 'Overweight', BMI>=30 ~ 'Obese'))
#data$BMICategory
data %>% count(BMICategory)
```
```{r}
#blood pressure categories: low, normal, elevated, high 
data <- data %>% mutate(BPCategory = case_when(BloodPressure<60 ~ 'Low', BloodPressure>=60 & BloodPressure<80 ~ 'Normal',BloodPressure >= 80 & BloodPressure < 90 ~ 'Elevated', BloodPressure >= 90 ~ 'High'))
data %>% count(BPCategory)
```


```{r}
values_to_scale <- c('Pregnancies','Glucose', 'BloodPressure','SkinThickness','Insulin','BMI','DiabetesPedigreeFunction','Age')
#scale gives a mean of 0 and a standard deviation of 1
data[values_to_scale] <- scale(data[values_to_scale])
summary(data) #to check the mean 
sd(data$Pregnancies) #to check the standard deviation 
```
```{r}
#adding an outcome column for interpretability
data <- data %>% mutate(OutcomeLabel = case_when(Outcome==0 ~ 'Not Diabetic', Outcome==1 ~ 'Diabetic'))
data %>% count(OutcomeLabel)
```

Step 3: Visualisation and Exploration 

```{r}
library(ggplot2)

density(data$Glucose)
#does not work yet because of the NA values that need to be replaced

```

```{r}
#distribution of BMI and age between diabetic and non-diabetic patients 

plot_bmi <- ggplot(data, aes(x=BMI, fill=OutcomeLabel)) + labs(title = 'BMI distribution', x='BMI', fill='(No)Diabetes') + geom_density(alpha = 0.5) 
  
plot_age <- ggplot(data, aes(x=Age, fill=OutcomeLabel)) + labs(title = 'Age distribution', x='Age', fill='(No)Diabetes') + geom_density(alpha = 0.5)

plot_bmi
plot_age

```
```{r}
install.packages("ggcorrplot")
library(ggcorrplot)
```

```{r}
#correlation matrix 
num_data <- data[sapply(data, is.numeric)] #in the mean time, took off the NA values but they should be replaced to avoid deleting too many rows 
#cor(num_data)
ggcorrplot(cor(num_data))
```

```{r}
#Age vs DiabetesPedigreeFunction  

plot_diabetes_age <- ggplot(data, aes(x=Age, y=DiabetesPedigreeFunction, color=OutcomeLabel)) + labs(title = 'Age vs DiabetesPedigreeFunction', x='Age', y='DiabetesPedigreeFunction', color='(Not)Diabetic') + geom_point(alpha = 0.5,size=2) 
plot_diabetes_age

```

```{r}
#two other maybe pertinent plots idk 

plot_diabetes_bmi <- ggplot(data, aes(x=BMI, y=DiabetesPedigreeFunction, color=OutcomeLabel)) + labs(title = 'BMI vs DiabetesPedigreeFunction', x='BMI', y='DiabetesPedigreeFunction', color='(Not)Diabetic') + geom_point(alpha = 0.5,size=2) 
plot_diabetes_bmi

```

Step 4: Modeling and Prediction (Data Science)

```{r}
#logistic regression model, we use the generalized linear model  

model <- glm(Outcome ~ Glucose + BMI + Age + DiabetesPedigreeFunction + Pregnancies + BloodPressure + SkinThickness, data = data, family = binomial)

summary(model)

#data$Predict <- predict(model, type='response')

```
```{r}
library("caret")
set.seed(123)
train_index <- sample(1:nrow(df_scaled), 0.8 * nrow(df_scaled))
train_data <- df_scaled[train_index, ]
test_data <- df_scaled[-train_index, ]

model <- glm(Outcome ~ Glucose + BMI + Age + DiabetesPedigreeFunction + Pregnancies + BloodPressure + SkinThickness, data = train_data, family = binomial)

test_data$PredictedProb <- predict(model, newdata = test_data, type = "response")
test_data$PredictedClass <- ifelse(test_data$PredictedProb > 0.5, 1, 0)

confusion_matrix <- table(Predicted = test_data$PredictedClass, Actual = test_data$Outcome)
accuracy <- mean(test_data$PredictedClass == test_data$Outcome)

confusion_matrix



#formula <- (89+29)/(89+23+13+29)
#formula



#summary(model)
#df_scaled$Predict <- predict(model, type='response')
#df_scaled$Predict
#exp(coef(model))
```


```{r}
#knn model 
library(class)
knn_model <- knn()
#still to do...
```

```{r}
library(caret)
```

```{r}
#cross-validation
training <- trainControl(method='cv',number=10)

model <- train(Outcome ~.,data=data, method = 'glm', family='binomial', trControl=training)

#doesn't work yet because of the NA values 

```

